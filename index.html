<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Rummy / Least Count Scorekeeper</title>

  <!-- PWA basics -->
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#0ea5e9" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- React (CDN) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- Babel for in-browser JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-50 text-slate-800">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useRef } = React;

    // ----- Helpers -----
    const STORAGE_KEY = "rummy_scorekeeper_v1";

    const uid = () =>
      Math.random().toString(36).slice(2) + Date.now().toString(36);

    const sum = (arr) =>
      arr.reduce((a, b) => a + (Number.isFinite(b) ? b : 0), 0);

    const clampScoreInput = (val) => {
      if (String(val).trim() === "") return "";
      const cleaned = String(val).replace(/[^0-9\-]/g, "");
      return cleaned.replace(/(?!^)-/g, ""); // only allow leading '-'
    };

    const download = (filename, content) => {
      const blob = new Blob([content], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    };

    // ----- Inline editable cell -----
    function InlineEditableNumber({ value, onChange, disabled }) {
      const [editing, setEditing] = useState(false);
      const [tmp, setTmp] = useState(String(value));
      const inputRef = useRef(null);

      useEffect(() => {
        if (editing) {
          setTmp(String(value));
          setTimeout(() => inputRef.current?.select(), 0);
        }
      }, [editing]);

      if (!editing) {
        return (
          <button
            disabled={disabled}
            onClick={() => setEditing(true)}
            className={
              "inline-block min-w-[3.5rem] text-right px-2 py-1 rounded-lg " +
              (disabled ? "text-slate-400" : "hover:bg-slate-100 active:bg-slate-200")
            }
            title={disabled ? "Eliminated" : "Edit score"}
          >
            {value}
          </button>
        );
      }

      return (
        <input
          ref={inputRef}
          inputMode="numeric"
          className="w-16 text-right rounded-lg border border-slate-300 px-2 py-1"
          value={tmp}
          onChange={(e) => setTmp(clampScoreInput(e.target.value))}
          onBlur={() => { onChange(Number(tmp) || 0); setEditing(false); }}
          onKeyDown={(e) => {
            if (e.key === "Enter") { onChange(Number(tmp) || 0); setEditing(false); }
            if (e.key === "Escape") setEditing(false);
          }}
          autoFocus
        />
      );
    }

    // ----- App -----
    function App() {
      const [state, setState] = useState(() => {
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) return JSON.parse(raw);
        } catch {}
        return {
          targetScore: 121,
          players: [],
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
        };
      });

      const rounds = useMemo(
        () => Math.max(0, ...state.players.map((p) => p.scores.length)),
        [state.players]
      );

      // autosave
      useEffect(() => {
        const updated = { ...state, updatedAt: new Date().toISOString() };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(updated));
      }, [state]);

      // player mgmt
      const [newPlayerName, setNewPlayerName] = useState("");
      const addPlayer = () => {
        const name = newPlayerName.trim();
        if (!name) return;
        setState((s) => ({
          ...s,
          players: [...s.players, { id: uid(), name, scores: [] }],
        }));
        setNewPlayerName("");
      };
      const renamePlayer = (id, name) => {
        setState((s) => ({
          ...s,
          players: s.players.map((p) => (p.id === id ? { ...p, name } : p)),
        }));
      };
      const removePlayer = (id) => {
        if (!confirm("Remove this player? Their scores will be lost.")) return;
        setState((s) => ({ ...s, players: s.players.filter((p) => p.id !== id) }));
      };

      // round entry
      const [pendingRound, setPendingRound] = useState({});
      useEffect(() => {
        const obj = {};
        state.players.forEach((p) => {
          obj[p.id] = pendingRound[p.id] ?? "0";
        });
        setPendingRound(obj);
        // eslint-disable-next-line react-hooks/exhaustive-deps
      }, [state.players.length]);

      const submitRound = () => {
        if (!state.players.length) return;
        const values = state.players.map((p) => ({
          id: p.id,
          val: Number(pendingRound[p.id] ?? 0) || 0,
        }));
        setState((s) => ({
          ...s,
          players: s.players.map((p) => ({
            ...p,
            scores: [...p.scores, values.find((r) => r.id === p.id)?.val ?? 0],
          })),
        }));
        const next = {};
        state.players.forEach((p) => (next[p.id] = "0"));
        setPendingRound(next);
      };

      const editScore = (playerId, roundIndex, newVal) => {
        setState((s) => ({
          ...s,
          players: s.players.map((p) => {
            if (p.id !== playerId) return p;
            const scores = [...p.scores];
            scores[roundIndex] = newVal;
            return { ...p, scores };
          }),
        }));
      };

      const clearAll = () => {
        if (!confirm("Start a new game? This will clear all players and scores.")) return;
        localStorage.removeItem(STORAGE_KEY);
        setState({
          targetScore: 121,
          players: [],
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
        });
        setPendingRound({});
      };

      // import/export
      const fileInputRef = useRef(null);
      const onExport = () =>
        download(
          `rummy_score_${new Date().toISOString().slice(0, 10)}.json`,
          JSON.stringify(state, null, 2)
        );
      const onImportClick = () => fileInputRef.current?.click();
      const onImportFile = (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = () => {
          try {
            const data = JSON.parse(String(reader.result));
            if (typeof data?.targetScore !== "number" || !Array.isArray(data?.players))
              throw new Error("Bad file");
            setState({ ...data, updatedAt: new Date().toISOString() });
          } catch {
            alert("Invalid file");
          }
        };
        reader.readAsText(file);
        e.target.value = "";
      };

      const totals = useMemo(() => {
        const m = new Map();
        state.players.forEach((p) => m.set(p.id, sum(p.scores)));
        return m;
      }, [state.players]);

      const isEliminated = (p) => (totals.get(p.id) >= state.targetScore);

      return (
        <div className="min-h-screen w-full p-4 sm:p-6">
          <div className="mx-auto max-w-3xl">
            <header className="flex flex-col gap-3 sm:flex-row sm:items-end sm:justify-between">
              <div>
                <h1 className="text-2xl font-bold tracking-tight">
                  Rummy / Least Count Scorekeeper
                </h1>
                <p className="text-sm text-slate-600">
                  Mobile-first • Autosaves • Edit any score • Eliminations turn red
                </p>
              </div>
              <div className="flex items-center gap-2">
                <button onClick={onExport} className="px-3 py-2 rounded-xl bg-white shadow hover:shadow-md active:shadow-sm text-sm">
                  Export
                </button>
                <button onClick={onImportClick} className="px-3 py-2 rounded-xl bg-white shadow hover:shadow-md active:shadow-sm text-sm">
                  Import
                </button>
                <input type="file" accept="application/json" ref={fileInputRef} onChange={onImportFile} className="hidden" />
                <button onClick={clearAll} className="px-3 py-2 rounded-xl bg-rose-600 text-white shadow hover:brightness-110 active:brightness-95 text-sm">
                  New Game
                </button>
              </div>
            </header>

            {/* Target Score */}
            <section className="mt-4 bg-white rounded-2xl shadow p-4">
              <label className="text-sm font-medium">Target score to eliminate</label>
              <div className="mt-2 flex items-center gap-3">
                <input
                  inputMode="numeric"
                  className="w-28 rounded-xl border border-slate-300 px-3 py-2 text-lg"
                  value={state.targetScore}
                  onChange={(e) => {
                    const v = parseInt(e.target.value.replace(/[^0-9]/g, ""), 10);
                    setState((s) => ({ ...s, targetScore: Number.isFinite(v) ? v : 0 }));
                  }}
                />
                <span className="text-slate-500 text-sm">Commonly 121 for Rummy</span>
              </div>
            </section>

            {/* Add Player */}
            <section className="mt-4 bg-white rounded-2xl shadow p-4">
              <div className="flex flex-col sm:flex-row gap-2 sm:items-end">
                <div className="flex-1">
                  <label className="text-sm font-medium">Add player</label>
                  <input
                    className="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2"
                    placeholder="Player name"
                    value={newPlayerName}
                    onChange={(e) => setNewPlayerName(e.target.value)}
                    onKeyDown={(e) => e.key === "Enter" && addPlayer()}
                  />
                </div>
                <button
                  onClick={addPlayer}
                  className="px-4 py-2 rounded-xl bg-emerald-600 text-white shadow hover:brightness-110 active:brightness-95"
                >
                  Add
                </button>
              </div>

              {state.players.length > 0 && (
                <ul className="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-2">
                  {state.players.map((p) => (
                    <li
                      key={p.id}
                      className={
                        "flex items-center justify-between rounded-xl border px-3 py-2 " +
                        (isEliminated(p) ? "bg-rose-50 border-rose-300" : "bg-slate-50 border-slate-200")
                      }
                    >
                      <div className="flex items-center gap-3 min-w-0">
                        <span
                          className={
                            "inline-flex items-center justify-center rounded-full w-7 h-7 text-sm font-semibold " +
                            (isEliminated(p) ? "bg-rose-100 text-rose-700" : "bg-slate-200 text-slate-700")
                          }
                        >
                          {p.name.slice(0, 1).toUpperCase()}
                        </span>
                        <input
                          className={
                            "min-w-0 flex-1 bg-transparent outline-none " +
                            (isEliminated(p) ? "text-rose-700 font-semibold" : "")
                          }
                          value={p.name}
                          onChange={(e) => renamePlayer(p.id, e.target.value)}
                        />
                      </div>
                      <div className="flex items-center gap-2">
                        <span className={"text-sm " + (isEliminated(p) ? "text-rose-700 font-semibold" : "text-slate-600")}>
                          Total: {sum(p.scores)}
                        </span>
                        <button
                          onClick={() => removePlayer(p.id)}
                          className="text-slate-500 hover:text-rose-600"
                          title="Remove"
                        >
                          ✕
                        </button>
                      </div>
                    </li>
                  ))}
                </ul>
              )}
            </section>

            {/* Enter Round */}
            {state.players.length > 0 && (
              <section className="mt-4 bg-white rounded-2xl shadow p-4">
                <h2 className="font-semibold">Enter round #{rounds + 1}</h2>
                <div className="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3">
                  {state.players.map((p) => (
                    <div
                      key={p.id}
                      className="flex items-center justify-between gap-2 rounded-xl border border-slate-200 px-3 py-2"
                    >
                      <div className={"font-medium truncate " + (isEliminated(p) ? "text-rose-700" : "")}>
                        {p.name}
                      </div>
                      <input
                        inputMode="numeric"
                        className={
                          "w-24 rounded-lg border px-3 py-1.5 text-right " +
                          (isEliminated(p) ? "border-rose-300 bg-rose-50 text-rose-700" : "border-slate-300")
                        }
                        value={pendingRound[p.id] ?? "0"}
                        onChange={(e) =>
                          setPendingRound((pr) => ({
                            ...pr,
                            [p.id]: clampScoreInput(e.target.value),
                          }))
                        }
                        disabled={isEliminated(p)}
                      />
                    </div>
                  ))}
                </div>
                <div className="mt-3 flex gap-2">
                  <button
                    onClick={submitRound}
                    className="px-4 py-2 rounded-xl bg-indigo-600 text-white shadow hover:brightness-110 active:brightness-95"
                  >
                    Save Round
                  </button>
                  <button
                    onClick={() => {
                      const next = {};
                      state.players.forEach((p) => (next[p.id] = "0"));
                      setPendingRound(next);
                    }}
                    className="px-4 py-2 rounded-xl bg-white border border-slate-300 shadow-sm"
                  >
                    Clear
                  </button>
                </div>
              </section>
            )}

            {/* Scoreboard */}
            {state.players.length > 0 && (
              <section className="mt-4 bg-white rounded-2xl shadow p-4 overflow-x-auto">
                <h2 className="font-semibold mb-2">Scoreboard</h2>
                <table className="min-w-full text-sm">
                  <thead>
                    <tr>
                      <th className="text-left p-2 border-b">Player</th>
                      {Array.from({ length: rounds }, (_, i) => (
                        <th key={i} className="text-right p-2 border-b">R{i + 1}</th>
                      ))}
                      <th className="text-right p-2 border-b">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    {state.players.map((p) => (
                      <tr key={p.id} className={isEliminated(p) ? "bg-rose-50" : ""}>
                        <td className={"p-2 border-b font-medium " + (isEliminated(p) ? "text-rose-700" : "")}>
                          {p.name}
                        </td>
                        {Array.from({ length: rounds }, (_, i) => {
                          const val = p.scores[i] ?? 0;
                          return (
                            <td key={i} className="p-1 border-b text-right">
                              <InlineEditableNumber
                                value={val}
                                disabled={false}
                                onChange={(nv) => editScore(p.id, i, nv)}
                              />
                            </td>
                          );
                        })}
                        <td className={"p-2 border-b text-right font-semibold " + (isEliminated(p) ? "text-rose-700" : "")}>
                          {sum(p.scores)}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
                <p className="text-xs text-slate-500 mt-2">
                  Tip: Tap any score to edit it later. Eliminated players (≥ target) are highlighted in red and disabled for new rounds.
                </p>
              </section>
            )}

            <footer className="py-6 text-center text-xs text-slate-400">
              <p>Data is stored locally on your device. Use Export to back up or move to another phone.</p>
              <p className="mt-2">© 2025 venkatsairama</p>
            </footer>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>

  <!-- Register the service worker -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .catch(err => console.log('SW registration failed:', err));
      });
    }
  </script>
</body>
</html>
